import cython  # type: ignore
from itertools import product

BLOSUM62: dict[tuple[int, ...], int] = {
    tuple(b'AA'): 4,
    tuple(b'AC'): 0,
    tuple(b'AD'): -2,
    tuple(b'AE'): -1,
    tuple(b'AF'): -2,
    tuple(b'AG'): 0,
    tuple(b'AH'): -2,
    tuple(b'AI'): -1,
    tuple(b'AK'): -1,
    tuple(b'AL'): -1,
    tuple(b'AM'): -1,
    tuple(b'AN'): -2,
    tuple(b'AP'): -1,
    tuple(b'AQ'): -1,
    tuple(b'AR'): -1,
    tuple(b'AS'): 1,
    tuple(b'AT'): 0,
    tuple(b'AV'): 0,
    tuple(b'AW'): -3,
    tuple(b'AY'): -2,
    tuple(b'CA'): 0,
    tuple(b'CC'): 9,
    tuple(b'CD'): -3,
    tuple(b'CE'): -4,
    tuple(b'CF'): -2,
    tuple(b'CG'): -3,
    tuple(b'CH'): -3,
    tuple(b'CI'): -1,
    tuple(b'CK'): -3,
    tuple(b'CL'): -1,
    tuple(b'CM'): -1,
    tuple(b'CN'): -3,
    tuple(b'CP'): -3,
    tuple(b'CQ'): -3,
    tuple(b'CR'): -3,
    tuple(b'CS'): -1,
    tuple(b'CT'): -1,
    tuple(b'CV'): -1,
    tuple(b'CW'): -2,
    tuple(b'CY'): -2,
    tuple(b'DA'): -2,
    tuple(b'DC'): -3,
    tuple(b'DD'): 6,
    tuple(b'DE'): 2,
    tuple(b'DF'): -3,
    tuple(b'DG'): -1,
    tuple(b'DH'): -1,
    tuple(b'DI'): -3,
    tuple(b'DK'): -1,
    tuple(b'DL'): -4,
    tuple(b'DM'): -3,
    tuple(b'DN'): 1,
    tuple(b'DP'): -1,
    tuple(b'DQ'): 0,
    tuple(b'DR'): -2,
    tuple(b'DS'): 0,
    tuple(b'DT'): -1,
    tuple(b'DV'): -3,
    tuple(b'DW'): -4,
    tuple(b'DY'): -3,
    tuple(b'EA'): -1,
    tuple(b'EC'): -4,
    tuple(b'ED'): 2,
    tuple(b'EE'): 5,
    tuple(b'EF'): -3,
    tuple(b'EG'): -2,
    tuple(b'EH'): 0,
    tuple(b'EI'): -3,
    tuple(b'EK'): 1,
    tuple(b'EL'): -3,
    tuple(b'EM'): -2,
    tuple(b'EN'): 0,
    tuple(b'EP'): -1,
    tuple(b'EQ'): 2,
    tuple(b'ER'): 0,
    tuple(b'ES'): 0,
    tuple(b'ET'): -1,
    tuple(b'EV'): -2,
    tuple(b'EW'): -3,
    tuple(b'EY'): -2,
    tuple(b'FA'): -2,
    tuple(b'FC'): -2,
    tuple(b'FD'): -3,
    tuple(b'FE'): -3,
    tuple(b'FF'): 6,
    tuple(b'FG'): -3,
    tuple(b'FH'): -1,
    tuple(b'FI'): 0,
    tuple(b'FK'): -3,
    tuple(b'FL'): 0,
    tuple(b'FM'): 0,
    tuple(b'FN'): -3,
    tuple(b'FP'): -4,
    tuple(b'FQ'): -3,
    tuple(b'FR'): -3,
    tuple(b'FS'): -2,
    tuple(b'FT'): -2,
    tuple(b'FV'): -1,
    tuple(b'FW'): 1,
    tuple(b'FY'): 3,
    tuple(b'GA'): 0,
    tuple(b'GC'): -3,
    tuple(b'GD'): -1,
    tuple(b'GE'): -2,
    tuple(b'GF'): -3,
    tuple(b'GG'): 6,
    tuple(b'GH'): -2,
    tuple(b'GI'): -4,
    tuple(b'GK'): -2,
    tuple(b'GL'): -4,
    tuple(b'GM'): -3,
    tuple(b'GN'): 0,
    tuple(b'GP'): -2,
    tuple(b'GQ'): -2,
    tuple(b'GR'): -2,
    tuple(b'GS'): 0,
    tuple(b'GT'): -2,
    tuple(b'GV'): -3,
    tuple(b'GW'): -2,
    tuple(b'GY'): -3,
    tuple(b'HA'): -2,
    tuple(b'HC'): -3,
    tuple(b'HD'): -1,
    tuple(b'HE'): 0,
    tuple(b'HF'): -1,
    tuple(b'HG'): -2,
    tuple(b'HH'): 8,
    tuple(b'HI'): -3,
    tuple(b'HK'): -1,
    tuple(b'HL'): -3,
    tuple(b'HM'): -2,
    tuple(b'HN'): 1,
    tuple(b'HP'): -2,
    tuple(b'HQ'): 0,
    tuple(b'HR'): 0,
    tuple(b'HS'): -1,
    tuple(b'HT'): -2,
    tuple(b'HV'): -3,
    tuple(b'HW'): -2,
    tuple(b'HY'): 2,
    tuple(b'IA'): -1,
    tuple(b'IC'): -1,
    tuple(b'ID'): -3,
    tuple(b'IE'): -3,
    tuple(b'IF'): 0,
    tuple(b'IG'): -4,
    tuple(b'IH'): -3,
    tuple(b'II'): 4,
    tuple(b'IK'): -3,
    tuple(b'IL'): 2,
    tuple(b'IM'): 1,
    tuple(b'IN'): -3,
    tuple(b'IP'): -3,
    tuple(b'IQ'): -3,
    tuple(b'IR'): -3,
    tuple(b'IS'): -2,
    tuple(b'IT'): -1,
    tuple(b'IV'): 3,
    tuple(b'IW'): -3,
    tuple(b'IY'): -1,
    tuple(b'KA'): -1,
    tuple(b'KC'): -3,
    tuple(b'KD'): -1,
    tuple(b'KE'): 1,
    tuple(b'KF'): -3,
    tuple(b'KG'): -2,
    tuple(b'KH'): -1,
    tuple(b'KI'): -3,
    tuple(b'KK'): 5,
    tuple(b'KL'): -2,
    tuple(b'KM'): -1,
    tuple(b'KN'): 0,
    tuple(b'KP'): -1,
    tuple(b'KQ'): 1,
    tuple(b'KR'): 2,
    tuple(b'KS'): 0,
    tuple(b'KT'): -1,
    tuple(b'KV'): -2,
    tuple(b'KW'): -3,
    tuple(b'KY'): -2,
    tuple(b'LA'): -1,
    tuple(b'LC'): -1,
    tuple(b'LD'): -4,
    tuple(b'LE'): -3,
    tuple(b'LF'): 0,
    tuple(b'LG'): -4,
    tuple(b'LH'): -3,
    tuple(b'LI'): 2,
    tuple(b'LK'): -2,
    tuple(b'LL'): 4,
    tuple(b'LM'): 2,
    tuple(b'LN'): -3,
    tuple(b'LP'): -3,
    tuple(b'LQ'): -2,
    tuple(b'LR'): -2,
    tuple(b'LS'): -2,
    tuple(b'LT'): -1,
    tuple(b'LV'): 1,
    tuple(b'LW'): -2,
    tuple(b'LY'): -1,
    tuple(b'MA'): -1,
    tuple(b'MC'): -1,
    tuple(b'MD'): -3,
    tuple(b'ME'): -2,
    tuple(b'MF'): 0,
    tuple(b'MG'): -3,
    tuple(b'MH'): -2,
    tuple(b'MI'): 1,
    tuple(b'MK'): -1,
    tuple(b'ML'): 2,
    tuple(b'MM'): 5,
    tuple(b'MN'): -2,
    tuple(b'MP'): -2,
    tuple(b'MQ'): 0,
    tuple(b'MR'): -1,
    tuple(b'MS'): -1,
    tuple(b'MT'): -1,
    tuple(b'MV'): 1,
    tuple(b'MW'): -1,
    tuple(b'MY'): -1,
    tuple(b'NA'): -2,
    tuple(b'NC'): -3,
    tuple(b'ND'): 1,
    tuple(b'NE'): 0,
    tuple(b'NF'): -3,
    tuple(b'NG'): 0,
    tuple(b'NH'): 1,
    tuple(b'NI'): -3,
    tuple(b'NK'): 0,
    tuple(b'NL'): -3,
    tuple(b'NM'): -2,
    tuple(b'NN'): 6,
    tuple(b'NP'): -2,
    tuple(b'NQ'): 0,
    tuple(b'NR'): 0,
    tuple(b'NS'): 1,
    tuple(b'NT'): 0,
    tuple(b'NV'): -3,
    tuple(b'NW'): -4,
    tuple(b'NY'): -2,
    tuple(b'PA'): -1,
    tuple(b'PC'): -3,
    tuple(b'PD'): -1,
    tuple(b'PE'): -1,
    tuple(b'PF'): -4,
    tuple(b'PG'): -2,
    tuple(b'PH'): -2,
    tuple(b'PI'): -3,
    tuple(b'PK'): -1,
    tuple(b'PL'): -3,
    tuple(b'PM'): -2,
    tuple(b'PN'): -2,
    tuple(b'PP'): 7,
    tuple(b'PQ'): -1,
    tuple(b'PR'): -2,
    tuple(b'PS'): -1,
    tuple(b'PT'): -1,
    tuple(b'PV'): -2,
    tuple(b'PW'): -4,
    tuple(b'PY'): -3,
    tuple(b'QA'): -1,
    tuple(b'QC'): -3,
    tuple(b'QD'): 0,
    tuple(b'QE'): 2,
    tuple(b'QF'): -3,
    tuple(b'QG'): -2,
    tuple(b'QH'): 0,
    tuple(b'QI'): -3,
    tuple(b'QK'): 1,
    tuple(b'QL'): -2,
    tuple(b'QM'): 0,
    tuple(b'QN'): 0,
    tuple(b'QP'): -1,
    tuple(b'QQ'): 5,
    tuple(b'QR'): 1,
    tuple(b'QS'): 0,
    tuple(b'QT'): -1,
    tuple(b'QV'): -2,
    tuple(b'QW'): -2,
    tuple(b'QY'): -1,
    tuple(b'RA'): -1,
    tuple(b'RC'): -3,
    tuple(b'RD'): -2,
    tuple(b'RE'): 0,
    tuple(b'RF'): -3,
    tuple(b'RG'): -2,
    tuple(b'RH'): 0,
    tuple(b'RI'): -3,
    tuple(b'RK'): 2,
    tuple(b'RL'): -2,
    tuple(b'RM'): -1,
    tuple(b'RN'): 0,
    tuple(b'RP'): -2,
    tuple(b'RQ'): 1,
    tuple(b'RR'): 5,
    tuple(b'RS'): -1,
    tuple(b'RT'): -1,
    tuple(b'RV'): -3,
    tuple(b'RW'): -3,
    tuple(b'RY'): -2,
    tuple(b'SA'): 1,
    tuple(b'SC'): -1,
    tuple(b'SD'): 0,
    tuple(b'SE'): 0,
    tuple(b'SF'): -2,
    tuple(b'SG'): 0,
    tuple(b'SH'): -1,
    tuple(b'SI'): -2,
    tuple(b'SK'): 0,
    tuple(b'SL'): -2,
    tuple(b'SM'): -1,
    tuple(b'SN'): 1,
    tuple(b'SP'): -1,
    tuple(b'SQ'): 0,
    tuple(b'SR'): -1,
    tuple(b'SS'): 4,
    tuple(b'ST'): 1,
    tuple(b'SV'): -2,
    tuple(b'SW'): -3,
    tuple(b'SY'): -2,
    tuple(b'TA'): 0,
    tuple(b'TC'): -1,
    tuple(b'TD'): -1,
    tuple(b'TE'): -1,
    tuple(b'TF'): -2,
    tuple(b'TG'): -2,
    tuple(b'TH'): -2,
    tuple(b'TI'): -1,
    tuple(b'TK'): -1,
    tuple(b'TL'): -1,
    tuple(b'TM'): -1,
    tuple(b'TN'): 0,
    tuple(b'TP'): -1,
    tuple(b'TQ'): -1,
    tuple(b'TR'): -1,
    tuple(b'TS'): 1,
    tuple(b'TT'): 5,
    tuple(b'TV'): 0,
    tuple(b'TW'): -2,
    tuple(b'TY'): -2,
    tuple(b'VA'): 0,
    tuple(b'VC'): -1,
    tuple(b'VD'): -3,
    tuple(b'VE'): -2,
    tuple(b'VF'): -1,
    tuple(b'VG'): -3,
    tuple(b'VH'): -3,
    tuple(b'VI'): 3,
    tuple(b'VK'): -2,
    tuple(b'VL'): 1,
    tuple(b'VM'): 1,
    tuple(b'VN'): -3,
    tuple(b'VP'): -2,
    tuple(b'VQ'): -2,
    tuple(b'VR'): -3,
    tuple(b'VS'): -2,
    tuple(b'VT'): 0,
    tuple(b'VV'): 4,
    tuple(b'VW'): -3,
    tuple(b'VY'): -1,
    tuple(b'WA'): -3,
    tuple(b'WC'): -2,
    tuple(b'WD'): -4,
    tuple(b'WE'): -3,
    tuple(b'WF'): 1,
    tuple(b'WG'): -2,
    tuple(b'WH'): -2,
    tuple(b'WI'): -3,
    tuple(b'WK'): -3,
    tuple(b'WL'): -2,
    tuple(b'WM'): -1,
    tuple(b'WN'): -4,
    tuple(b'WP'): -4,
    tuple(b'WQ'): -2,
    tuple(b'WR'): -3,
    tuple(b'WS'): -3,
    tuple(b'WT'): -2,
    tuple(b'WV'): -3,
    tuple(b'WW'): 11,
    tuple(b'WY'): 2,
    tuple(b'YA'): -2,
    tuple(b'YC'): -2,
    tuple(b'YD'): -3,
    tuple(b'YE'): -2,
    tuple(b'YF'): 3,
    tuple(b'YG'): -3,
    tuple(b'YH'): 2,
    tuple(b'YI'): -1,
    tuple(b'YK'): -2,
    tuple(b'YL'): -1,
    tuple(b'YM'): -1,
    tuple(b'YN'): -2,
    tuple(b'YP'): -3,
    tuple(b'YQ'): -1,
    tuple(b'YR'): -2,
    tuple(b'YS'): -2,
    tuple(b'YT'): -2,
    tuple(b'YV'): -1,
    tuple(b'YW'): 2,
    tuple(b'YY'): 7,
}


@cython.ccall
def blosum62_score(
    a: bytes,
    b: bytes,
    fs_as: int = ord(b'X'),
    del_as: int = ord(b'-'),
    a_fs_penalty: int = -1,
    b_fs_penalty: int = -1,
    a_del_penalty: int = -1,
    b_del_penalty: int = -1
) -> float:
    aa_a: int
    aa_b: int
    total_score: float = 0.
    total_n: int = 0
    for aa_a, aa_b in product(a, b):
        if aa_a == aa_b == del_as:
            # both are in-frame deletions, no penalty applied
            pass
        elif aa_a == del_as:
            # a is in-frame deletion but not b
            total_score += a_del_penalty
        elif aa_b == del_as:
            # b is in-frame deletion but not a
            total_score += b_del_penalty
        elif aa_a == aa_b == fs_as:
            # both are out-frame deletions; half penalty
            total_score += (a_fs_penalty + b_fs_penalty) / 2
        elif aa_a == fs_as:
            # a is out-frame deletion but not b
            total_score += a_fs_penalty
        elif aa_b == fs_as:
            # b is out-frame deletion but not a
            total_score += b_fs_penalty
        else:
            # if a or b is unrecognizable, silently skip
            total_score += BLOSUM62.get((aa_a, aa_b), 0)
        total_n += 1
    return total_score / total_n if total_n else 0.
